<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PR #{{ pr.number }} - {{ config.APP_TITLE }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <header>
      <div class="breadcrumb">
        <a href="/">â† PR ëª©ë¡ìœ¼ë¡œ</a>
      </div>
      <h1>ğŸ“‹ PR #{{ pr.number }}</h1>
      <div class="summary">
        <a href="{{ pr.url }}" target="_blank" rel="noopener noreferrer" class="pr-title-link">
          {{ pr.title }}
        </a>
      </div>
      <div class="pr-meta-info">
        {{ owner }}/{{ name }}
      </div>
    </header>

    <div class="filters">
      <form method="get" action="/pr/{{ pr.number }}" id="filterForm">
        <div class="filter-group">
          <label>
            <input type="checkbox" name="include_resolved" value="true" 
                   {% if include_resolved %}checked{% endif %}
                   onchange="this.form.submit()">
            í•´ê²°ëœ ì½”ë©˜íŠ¸ í¬í•¨
          </label>
        </div>
        <div class="filter-group">
          <label>
            <input type="checkbox" name="compact_mode" value="true" 
                   {% if compact_mode %}checked{% endif %}
                   onchange="this.form.submit()">
            ì»´íŒ©íŠ¸ ëª¨ë“œ
          </label>
        </div>
      </form>
    </div>

    <main class="pr-detail-layout">
      <!-- ì™¼ìª½: ë¦¬ë·° ì½”ë©˜íŠ¸ -->
      <div class="pr-detail-main">
        {% if pr.comments %}
          <div class="comments-container">
            <div class="comments-header">
              <h2>ë¦¬ë·° ì½”ë©˜íŠ¸</h2>
              <span class="comment-count">{{ pr.comments|length }}ê°œ</span>
            </div>

            {% for c in pr.comments %}
            {% if compact_mode %}
              <!-- ì»´íŒ©íŠ¸ ëª¨ë“œ -->
              <div class="review-card compact {% if c.isResolved %}resolved{% endif %}" 
                   data-comment-id="{{ c.databaseId }}" 
                   data-pr-number="{{ pr.number }}">
                <div class="compact-review">
                  <div class="compact-header">
                    <div class="compact-header-row">
                      <label class="comment-checkbox-label">
                        <input type="checkbox" 
                               class="comment-checkbox" 
                               data-comment-id="{{ c.databaseId }}" 
                               data-pr-number="{{ pr.number }}"
                               aria-label="ëŒ€ì‘ ì™„ë£Œ ì²´í¬">
                        <span class="checkbox-text">ëŒ€ì‘ ì™„ë£Œ</span>
                      </label>
                      <span class="compact-author">
                        {% if c.authorUrl %}
                          <a href="{{ c.authorUrl }}" target="_blank" rel="noopener noreferrer">
                            {{ c.author }}
                          </a>
                        {% else %}
                          {{ c.author }}
                        {% endif %}
                      </span>
                      <span class="compact-time">{{ c.createdAt|format_time }}</span>
                    </div>
                    {% if c.path %}
                      <div class="compact-file-info">
                        <div class="compact-file-row">
                          <span class="file-icon">ğŸ“„</span>
                          <code class="compact-path">{{ c.path }}</code>
                        </div>
                        {% if c.lineInfo %}
                          <span class="compact-line">{{ c.lineInfo }}</span>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                  <div class="compact-body">
                    {{ c.bodyHTML_safe }}
                  </div>
                  {% if c.url %}
                    <div class="compact-actions">
                      <a href="{{ c.url }}" target="_blank" rel="noopener noreferrer" class="compact-link">
                        GitHubì—ì„œ ë³´ê¸° â†’
                      </a>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% else %}
              <!-- ìƒì„¸ ëª¨ë“œ -->
            <div class="review-card {% if c.isResolved %}resolved{% endif %}" 
                 data-comment-id="{{ c.databaseId }}" 
                 data-pr-number="{{ pr.number }}">
              <!-- ì¹´ë“œ í—¤ë” -->
              <div class="card-header">
                <div class="author-info">
                  {% if c.avatarUrl %}
                    <img src="{{ c.avatarUrl }}" alt="{{ c.author }}" class="avatar">
                  {% else %}
                    <div class="avatar-placeholder">{{ c.author[0]|upper }}</div>
                  {% endif %}
                  <div class="author-details">
                    <div class="author-name">
                      {% if c.authorUrl %}
                        <a href="{{ c.authorUrl }}" target="_blank" rel="noopener noreferrer">
                          {{ c.author }}
                        </a>
                      {% else %}
                        {{ c.author }}
                      {% endif %}
                      {% if c.isResolved %}
                        <span class="resolved-badge">âœ“ í•´ê²°ë¨</span>
                      {% endif %}
                    </div>
                    <div class="comment-meta">
                      <span class="comment-time">{{ c.createdAt|format_time }}</span>
                      {% if c.url %}
                        <span class="separator">â€¢</span>
                        <a href="{{ c.url }}" target="_blank" rel="noopener noreferrer" class="github-link-small">
                          GitHubì—ì„œ ë³´ê¸°
                        </a>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <!-- ëŒ€ì‘ ì™„ë£Œ ì²´í¬ë°•ìŠ¤ -->
                <label class="comment-checkbox-label">
                  <input type="checkbox" 
                         class="comment-checkbox" 
                         data-comment-id="{{ c.databaseId }}" 
                         data-pr-number="{{ pr.number }}"
                         aria-label="ëŒ€ì‘ ì™„ë£Œ ì²´í¬">
                  <span class="checkbox-text">ëŒ€ì‘ ì™„ë£Œ</span>
                </label>
              </div>

              <!-- íŒŒì¼ ì •ë³´ -->
              {% if c.path %}
                <div class="file-info">
                  <span class="file-icon">ğŸ“„</span>
                  <span class="file-path">{{ c.path }}</span>
                  {% if c.lineInfo %}
                    <span class="line-info">{{ c.lineInfo }}</span>
                  {% endif %}
                </div>
              {% endif %}

              <!-- Diff Hunk -->
              {% if c.diffHunk %}
                <div class="diff-container">
                  <pre class="diff"><code>{{ c.diffHunk }}</code></pre>
                </div>
              {% endif %}

              <!-- ë¦¬ë·° ë‚´ìš© -->
              <div class="review-body">
                {{ c.bodyHTML_safe }}
              </div>

              <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
              {% if c.replies %}
                <div class="replies-section">
                  <div class="replies-header">
                    <span class="replies-count">ğŸ’¬ {{ c.replies|length }}ê°œì˜ ëŒ“ê¸€</span>
                  </div>
                  {% for reply in c.replies %}
                    <div class="reply-item">
                      <div class="reply-header">
                        {% if reply.avatarUrl %}
                          <img src="{{ reply.avatarUrl }}" alt="{{ reply.author }}" class="reply-avatar">
                        {% else %}
                          <div class="reply-avatar-placeholder">{{ reply.author[0]|upper }}</div>
                        {% endif %}
                        <div class="reply-author">
                          {% if reply.authorUrl %}
                            <a href="{{ reply.authorUrl }}" target="_blank" rel="noopener noreferrer">
                              {{ reply.author }}
                            </a>
                          {% else %}
                            {{ reply.author }}
                          {% endif %}
                        </div>
                        <span class="reply-time">{{ reply.createdAt|format_time }}</span>
                      </div>
                      <div class="reply-body">
                        {{ reply.bodyHTML|safe }}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}

              <!-- ë‹µê¸€ ì‘ì„± í¼ -->
              <div class="reply-form-section">
                <form class="reply-form" data-comment-id="{{ c.databaseId }}" data-pr-number="{{ pr.number }}">
                  <textarea 
                    name="body" 
                    class="reply-input" 
                    placeholder="ë‹µê¸€ì„ ì‘ì„±í•˜ì„¸ìš”..." 
                    rows="3"
                    required
                  ></textarea>
                  <div class="reply-form-actions">
                    <button type="submit" class="reply-submit-btn">ë‹µê¸€ ì‘ì„±</button>
                    <span class="reply-status"></span>
                  </div>
                </form>
              </div>
            </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        <div class="no-comments">
          <div class="no-comments-icon">âœ…</div>
          <p>
            {% if include_resolved %}
              ì´ PRì—ëŠ” ë¦¬ë·° ì½”ë©˜íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.
            {% else %}
              ì´ PRì—ëŠ” ë¯¸í•´ê²° ë¦¬ë·° ì½”ë©˜íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.
            {% endif %}
          </p>
          {% if not include_resolved %}
            <p class="hint">
              <a href="?include_resolved=true">í•´ê²°ëœ ì½”ë©˜íŠ¸ í¬í•¨í•˜ê¸°</a>
            </p>
          {% endif %}
        </div>
      {% endif %}
      </div>

      <!-- ì˜¤ë¥¸ìª½: ì»¤ë°‹ ëª©ë¡ -->
      <aside class="pr-detail-sidebar">
        <div class="commits-container">
          <div class="commits-header">
            <h3>ğŸ“¦ ì»¤ë°‹ ëª©ë¡</h3>
            <span class="commits-count">{{ pr.commits|length }}ê°œ</span>
          </div>
          
          {% if pr.commits %}
            <div class="commits-list">
              {% for commit in pr.commits %}
                <div class="commit-item">
                  <div class="commit-header">
                    <div class="commit-info">
                      <div class="commit-message">
                        <a href="{{ commit.url }}" target="_blank" rel="noopener noreferrer" title="{{ commit.message }}">
                          {{ commit.messageHeadline }}
                        </a>
                      </div>
                      <div class="commit-meta">
                        <span class="commit-sha">
                          <code>{{ commit.abbreviatedOid }}</code>
                        </span>
                        <span class="commit-author">
                          {% if commit.authorLogin %}
                            <a href="{{ commit.authorUrl }}" target="_blank" rel="noopener noreferrer">
                              {{ commit.authorLogin }}
                            </a>
                          {% else %}
                            {{ commit.authorName }}
                          {% endif %}
                        </span>
                        <span class="commit-time">{{ commit.committedDate|format_time }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="no-commits">
              <p>ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          {% endif %}
        </div>
      </aside>
    </main>

    <footer>
      <p>Powered by GitHub CLI & GraphQL API</p>
    </footer>
  </div>

  <script>
    /**
     * ì½”ë©˜íŠ¸ ì²´í¬ ìƒíƒœë¥¼ ì„œë²„ì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜ (API í˜¸ì¶œ)
     * @param {number} prNumber - PR ë²ˆí˜¸
     * @param {string} commentId - ì½”ë©˜íŠ¸ ID (databaseId)
     * @param {boolean} checked - ì²´í¬ ì—¬ë¶€
     * @returns {Promise<boolean>} ì„±ê³µ ì—¬ë¶€
     */
    async function saveCommentCheckState(prNumber, commentId, checked) {
      try {
        const url = `/api/pr/${prNumber}/comments/${commentId}/check`;
        
        if (checked) {
          // ì²´í¬ ìƒíƒœ ì €ì¥
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ is_checked: true })
          });
          
          const result = await response.json();
          if (!result.success) {
            throw new Error(result.error || 'ì²´í¬ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨');
          }
          return true;
        } else {
          // ì²´í¬ í•´ì œ (ì‚­ì œ)
          const response = await fetch(url, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          if (!result.success) {
            throw new Error(result.error || 'ì²´í¬ ìƒíƒœ ì‚­ì œ ì‹¤íŒ¨');
          }
          return true;
        }
      } catch (error) {
        console.error('ì²´í¬ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:', error);
        return false;
      }
    }

    /**
     * ì½”ë©˜íŠ¸ ì²´í¬ ìƒíƒœë¥¼ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ (API í˜¸ì¶œ)
     * @param {number} prNumber - PR ë²ˆí˜¸
     * @param {string} commentId - ì½”ë©˜íŠ¸ ID (databaseId)
     * @returns {Promise<boolean>} ì²´í¬ ì—¬ë¶€
     */
    async function loadCommentCheckState(prNumber, commentId) {
      try {
        const url = `/api/pr/${prNumber}/comments/${commentId}/check`;
        const response = await fetch(url, {
          method: 'GET'
        });
        
        const result = await response.json();
        if (result.success && result.data) {
          return result.data.is_checked === true;
        }
        return false;
      } catch (error) {
        console.error('ì²´í¬ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:', error);
        return false;
      }
    }

    /**
     * PRì˜ ëª¨ë“  ì½”ë©˜íŠ¸ ì²´í¬ ìƒíƒœë¥¼ í•œ ë²ˆì— ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
     * @param {number} prNumber - PR ë²ˆí˜¸
     * @returns {Promise<Object>} ì½”ë©˜íŠ¸ IDë¥¼ í‚¤ë¡œ í•˜ëŠ” ì²´í¬ ìƒíƒœ ê°ì²´
     */
    async function loadAllCommentChecks(prNumber) {
      try {
        const url = `/api/pr/${prNumber}/comments/checks`;
        const response = await fetch(url, {
          method: 'GET'
        });
        
        const result = await response.json();
        if (result.success && result.data) {
          return result.data;
        }
        return {};
      } catch (error) {
        console.error('ì²´í¬ ìƒíƒœ ì¼ê´„ ì¡°íšŒ ì‹¤íŒ¨:', error);
        return {};
      }
    }

    /**
     * ì²´í¬ë°•ìŠ¤ ìƒíƒœì— ë”°ë¼ ì½”ë©˜íŠ¸ ì¹´ë“œì— ìŠ¤íƒ€ì¼ ì ìš©
     * @param {HTMLElement} checkbox - ì²´í¬ë°•ìŠ¤ ìš”ì†Œ
     */
    function updateCommentCardStyle(checkbox) {
      const commentCard = checkbox.closest('.review-card');
      if (checkbox.checked) {
        commentCard.classList.add('checked');
      } else {
        commentCard.classList.remove('checked');
      }
    }

    // Diff í¬ë§¤íŒ…
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.diff code').forEach(function(codeBlock) {
        const html = codeBlock.innerHTML;
        const lines = html.split('\n');
        
        const formatted = lines.map(line => {
          const decoded = line.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
          
          if (decoded.startsWith('@@')) {
            return '<span class="diff-hunk-header">' + line + '</span>';
          } else if (decoded.startsWith('+') && !decoded.startsWith('+++')) {
            return '<span class="diff-addition">' + line + '</span>';
          } else if (decoded.startsWith('-') && !decoded.startsWith('---')) {
            return '<span class="diff-deletion">' + line + '</span>';
          } else if (decoded.startsWith('+++') || decoded.startsWith('---')) {
            return '<span class="diff-file">' + line + '</span>';
          } else if (decoded.startsWith('...')) {
            return '<span class="diff-omitted">' + line + '</span>';
          } else {
            return '<span class="diff-context">' + line + '</span>';
          }
        }).join('\n');
        
        codeBlock.innerHTML = formatted;
      });

      // ì½”ë©˜íŠ¸ ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      (async function() {
        // PR ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸° (ì²« ë²ˆì§¸ ì²´í¬ë°•ìŠ¤ì—ì„œ)
        const firstCheckbox = document.querySelector('.comment-checkbox');
        if (!firstCheckbox) return;
        
        const prNumber = parseInt(firstCheckbox.dataset.prNumber);
        
        // ëª¨ë“  ì½”ë©˜íŠ¸ì˜ ì²´í¬ ìƒíƒœë¥¼ í•œ ë²ˆì— ë¶ˆëŸ¬ì˜¤ê¸°
        const allChecks = await loadAllCommentChecks(prNumber);
        
        // ê° ì²´í¬ë°•ìŠ¤ì— ì²´í¬ ìƒíƒœ ì ìš©
        document.querySelectorAll('.comment-checkbox').forEach(function(checkbox) {
          const commentId = checkbox.dataset.commentId;
          
          // ì €ì¥ëœ ì²´í¬ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
          const isChecked = allChecks[commentId]?.is_checked === true;
          checkbox.checked = isChecked;
          updateCommentCardStyle(checkbox);
          
          // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          checkbox.addEventListener('change', async function() {
            const checked = this.checked;
            const originalChecked = this.checked;
            
            // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ (ë‚™ê´€ì  ì—…ë°ì´íŠ¸)
            updateCommentCardStyle(this);
            
            // ì„œë²„ì— ì €ì¥ ì‹œë„
            const success = await saveCommentCheckState(prNumber, commentId, checked);
            
            if (!success) {
              // ì‹¤íŒ¨ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë³µì›
              this.checked = !originalChecked;
              updateCommentCardStyle(this);
              alert('ì²´í¬ ìƒíƒœ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
          });
        });
      })();

      // ë‹µê¸€ í¼ ì œì¶œ ì²˜ë¦¬
      document.querySelectorAll('.reply-form').forEach(function(form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const commentId = form.dataset.commentId;
          const prNumber = form.dataset.prNumber;
          const textarea = form.querySelector('textarea[name="body"]');
          const submitBtn = form.querySelector('.reply-submit-btn');
          const statusSpan = form.querySelector('.reply-status');
          const body = textarea.value.trim();
          
          if (!body) {
            return;
          }
          
          // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© ìƒíƒœ
          submitBtn.disabled = true;
          submitBtn.textContent = 'ì „ì†¡ ì¤‘...';
          statusSpan.textContent = '';
          
          try {
            const formData = new FormData();
            formData.append('comment_id', commentId);
            formData.append('body', body);
            
            const response = await fetch(`/pr/${prNumber}/reply`, {
              method: 'POST',
              body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
              statusSpan.textContent = 'âœ“ ë‹µê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...';
              statusSpan.style.color = '#1a7f37';
              
              // 2ì´ˆ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
              setTimeout(() => {
                window.location.reload();
              }, 2000);
            } else {
              throw new Error(result.error || 'ë‹µê¸€ ì‘ì„± ì‹¤íŒ¨');
            }
          } catch (error) {
            statusSpan.textContent = 'âœ— ' + error.message;
            statusSpan.style.color = '#d73a49';
            
            // ë²„íŠ¼ ë³µì›
            submitBtn.disabled = false;
            submitBtn.textContent = 'ë‹µê¸€ ì‘ì„±';
          }
        });
      });
    });
  </script>
</body>
</html>
